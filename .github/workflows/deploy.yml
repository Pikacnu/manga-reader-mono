name: Build and Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set Gitea Registry Env
        run: |
          # 萃取 Gitea 主機名與連接埠 (例如 server:3000)
          GITEA_HOST=$(echo "${{ github.server_url }}" | sed -e 's|^https://||' -e 's|^http://||')
          echo "REGISTRY_SERVER=$GITEA_HOST" >> $GITHUB_ENV
          echo "IMAGE_PATH=$GITEA_HOST/${{ github.repository_owner }}" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Gitea Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_SERVER }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Web Image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/web
          push: true
          tags: ${{ env.IMAGE_PATH }}/manga-reader-web:latest

  build-image-processor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set Gitea Registry Env
        run: |
          GITEA_HOST=$(echo "${{ github.server_url }}" | sed -e 's|^https://||' -e 's|^http://||')
          echo "REGISTRY_SERVER=$GITEA_HOST" >> $GITHUB_ENV
          echo "IMAGE_PATH=$GITEA_HOST/${{ github.repository_owner }}" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Gitea Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_SERVER }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Image Processor
        uses: docker/build-push-action@v5
        with:
          context: ./apps/image-processer
          push: true
          tags: ${{ env.IMAGE_PATH }}/manga-reader-image-processor:latest

  publish-helm:
    runs-on: ubuntu-latest
    needs: [build-web, build-image-processor]
    steps:
      - uses: actions/checkout@v4

      - name: Set Gitea Registry Env
        run: |
          GITEA_HOST=$(echo "${{ github.server_url }}" | sed -e 's|^https://||' -e 's|^http://||')
          echo "REGISTRY_SERVER=$GITEA_HOST" >> $GITHUB_ENV
          echo "IMAGE_PATH=$GITEA_HOST/${{ github.repository_owner }}" >> $GITHUB_ENV

      - name: Install Helm
        uses: azure/setup-helm@v3

      - name: Gitea Helm Registry Login
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login "$REGISTRY_SERVER" --username "${{ github.actor }}" --password-stdin

      - name: Build and Push Helm Chart to Gitea
        run: |
          helm package ./helm/manga-reader
          # 使用雙引號確保環境變數正確替換，oci:// 必須是字串格式
          helm push manga-reader-*.tgz "oci://$IMAGE_PATH"
