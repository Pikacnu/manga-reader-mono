FROM oven/bun:latest

WORKDIR /app

# Install dependencies (retaining node_modules)
COPY package.json bun.lockb* ./
RUN bun install --frozen-lockfile || bun install

# Copy source code
COPY . .

ENV NODE_ENV=production

# Build the Next.js application
RUN bun run build

EXPOSE 3000

# Run migration and start the server using bun run
ENTRYPOINT ["sh", "-c", "bun run migrate && bun run start -- --hostname 0.0.0.0"]
