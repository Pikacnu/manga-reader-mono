apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "manga-reader.fullname" . }}-nfs-config
data:
  NFS_SERVER: {{ .Values.nfs.server | quote }}
  NFS_PATH_PGDATA: {{ .Values.nfs.paths.pgdata | quote }}
  NFS_PATH_CACHE: {{ .Values.nfs.paths.cache | quote }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "manga-reader.fullname" . }}-domain-config
data:
  WEB_DOMAIN: {{ .Values.domain.web | quote }}
  IMG_DOMAIN: {{ .Values.domain.img | quote }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "manga-reader.fullname" . }}-web-config
data:
  IMAGE_SERVER_URL_INNER: "http://{{ include "manga-reader.fullname" . }}-image-processor-service:3001"
  MAIL_HOST: {{ .Values.config.mailHost | quote }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "manga-reader.fullname" . }}-image-processor-config
data:
  PORT: {{ .Values.config.imageProcessor.port | quote }}
  HOST: {{ .Values.config.imageProcessor.host | quote }}
  UPLOADS_DIR: {{ .Values.config.imageProcessor.uploadsDir | quote }}
  BACKUP_MOUNT_DIR: {{ .Values.config.imageProcessor.backupMountDir | quote }}
  SHARED_SSD_CACHE_DIR: {{ .Values.config.imageProcessor.sharedSsdCacheDir | quote }}
  SHARED_SSD_CACHE_DURATION_IN_SECONDS: {{ .Values.config.imageProcessor.sharedSsdCacheDuration | quote }}
  CACHE_MAX_AGE: {{ .Values.config.imageProcessor.cacheMaxAge | quote }}
  MAX_UPLOAD_SIZE: {{ .Values.config.imageProcessor.maxUploadSize | quote }}
  BACKTRACK_DURATION_IN_SECONDS: {{ .Values.config.imageProcessor.backtrackDuration | quote }}
  RAM_CACHE_EXPIRY_DURATION: {{ .Values.config.imageProcessor.ramCacheExpiryDuration | quote }}
  MAX_RAM_CACHE_SIZE: {{ .Values.config.imageProcessor.maxRamCacheSize | quote }}
  MAX_SHARED_SSD_SIZE_GB: {{ .Values.config.imageProcessor.maxSharedSsdSizeGb | quote }}
  S3_ENDPOINT: {{ .Values.s3.endpoint | quote }}
  S3_BUCKET_NAME: {{ .Values.s3.bucketName | quote }}
  S3_VIRTUAL_HOSTED_STYLE: {{ .Values.s3.virtualHostedStyle | quote }}
  API_KEY: {{ .Values.secrets.imageServerApiKey | quote }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "manga-reader.fullname" . }}-postgres-init-script
data:
  init-db.sh: |
    #!/bin/bash
    set -e
    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "postgres" <<-EOSQL
        CREATE USER ${WEB_DB_USER} WITH PASSWORD '${WEB_DB_PASSWORD}';
        CREATE DATABASE {{ .Values.database.web.db }};
        GRANT ALL PRIVILEGES ON DATABASE {{ .Values.database.web.db }} TO ${WEB_DB_USER};
        
        CREATE USER ${PROCESSOR_DB_USER} WITH PASSWORD '${PROCESSOR_DB_PASSWORD}';
        CREATE DATABASE {{ .Values.database.processor.db }};
        GRANT ALL PRIVILEGES ON DATABASE {{ .Values.database.processor.db }} TO ${PROCESSOR_DB_USER};
    EOSQL

    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "{{ .Values.database.web.db }}" -c "GRANT ALL ON SCHEMA public TO ${WEB_DB_USER};"
    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "{{ .Values.database.processor.db }}" -c "GRANT ALL ON SCHEMA public TO ${PROCESSOR_DB_USER};"
